#!/bin/bash

# Script mejorado para gestionar animaciones en macOS
# Versi√≥n optimizada con m√°xima desactivaci√≥n de efectos
# Autor: Sistema de gesti√≥n de animaciones avanzado
# Fecha: $(date)

# Funci√≥n para crear backup de configuraciones
crear_backup() {
    echo "üíæ Creando backup de configuraciones..."
    
    local backup_dir="$HOME/animaciones_backup_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$backup_dir"
    
    # Backup de configuraciones principales
    defaults read com.apple.dock > "$backup_dir/dock_backup.plist" 2>/dev/null || true
    defaults read NSGlobalDomain > "$backup_dir/global_backup.plist" 2>/dev/null || true
    defaults read com.apple.finder > "$backup_dir/finder_backup.plist" 2>/dev/null || true
    defaults read com.apple.universalaccess > "$backup_dir/accessibility_backup.plist" 2>/dev/null || true
    
    echo "‚úÖ Backup creado en: $backup_dir"
    echo "üîÑ Presiona cualquier tecla para continuar..."
    read -n 1 -s
}

# Funci√≥n para desactivar TODAS las animaciones (modo extremo)
desactivar_animaciones_extremo() {
    echo "üöÄ DESACTIVANDO TODAS LAS ANIMACIONES - MODO EXTREMO"
    echo "=================================================="
    
    # === DOCK ===
    echo "üîß Configurando Dock..."
    
    # M√âTODO ALTERNATIVO: Usar "suck" con configuraciones especiales
    # El efecto "suck" es el m√°s r√°pido cuando se combina con estas configuraciones
    defaults write com.apple.dock mineffect -string "suck"
    defaults write com.apple.dock minimize-to-application -bool YES
    
    # Configuraci√≥n cr√≠tica: Establecer duraci√≥n de animaci√≥n a 0
    defaults write com.apple.dock expose-animation-duration -float 0.0
    defaults write com.apple.dock springboard-page-duration -float 0.0
    defaults write com.apple.dock springboard-show-duration -float 0.0
    defaults write com.apple.dock springboard-hide-duration -float 0.0
    
    # Desactivar todas las animaciones relacionadas
    defaults write com.apple.dock workspaces-swoosh-animation-off -bool YES
    defaults write com.apple.dock workspaces-edge-delay -float 0.0
    
    # Configuraci√≥n adicional para hacer el Dock m√°s r√°pido
    defaults write com.apple.Dock autohide-delay -float 0
    defaults write com.apple.dock autohide-time-modifier -float 0
    defaults write com.apple.dock tilesize -int 48
    
    # Importante: Desactivar indicadores de aplicaciones para mayor velocidad
    defaults write com.apple.dock static-only -bool YES
    defaults write com.apple.dock show-process-indicators -bool NO
    
    # Intentar desactivar completamente las animaciones de minimizar
    defaults write com.apple.dock enable-spring-load-actions-on-all-items -bool false
    defaults write com.apple.dock mouse-over-hilite-stack -bool false
    defaults write com.apple.dock static-only -bool true
    
    # Desactivar animaciones del Dock
    defaults write com.apple.dock launchanim -bool false
    defaults write com.apple.dock expose-animation-duration -float 0.0
    defaults write com.apple.dock springboard-show-duration -float 0.0
    defaults write com.apple.dock springboard-hide-duration -float 0.0
    defaults write com.apple.dock springboard-page-duration -float 0.0
    
    # Desactivar efectos de zoom y magnificaci√≥n
    defaults write com.apple.dock magnification -bool false
    defaults write com.apple.dock largesize -float 16
    
    # Desactivar animaci√≥n de rebote en Dock
    defaults write com.apple.dock no-bouncing -bool true
    
    # Acelerar auto-hide del Dock
    defaults write com.apple.dock autohide-delay -float 0.0
    defaults write com.apple.dock autohide-time-modifier -float 0.0
    
    # === CONFIGURAR APLICACIONES POR DEFECTO EN EL DOCK ===
    echo "üîß Configurando aplicaciones por defecto en el Dock..."
    
    # Funci√≥n auxiliar para agregar aplicaci√≥n al Dock
    agregar_app_al_dock() {
        local app_path="$1"
        if [ -e "$app_path" ]; then
            defaults write com.apple.dock persistent-apps -array-add "<dict><key>tile-data</key><dict><key>file-data</key><dict><key>_CFURLString</key><string>$app_path</string><key>_CFURLStringType</key><integer>0</integer></dict></dict></dict>"
            echo "   ‚úì Agregada: $(basename "$app_path")"
        else
            echo "   ‚úó No encontrada: $(basename "$app_path")"
        fi
    }
    
    # Primero, limpiar el Dock actual
    defaults write com.apple.dock persistent-apps -array
    
    # Agregar las aplicaciones en orden
    agregar_app_al_dock "/Applications/Google Chrome.app"
    agregar_app_al_dock "/Applications/Firefox.app"
    agregar_app_al_dock "/Applications/Slack.app"
    agregar_app_al_dock "/System/Applications/Utilities/Terminal.app"
    agregar_app_al_dock "/Applications/ChatGPT.app"
    agregar_app_al_dock "/Applications/Cursor.app"
    
    # Forzar que los cambios se apliquen inmediatamente
    defaults write com.apple.dock static-only -bool false
    
    echo "‚úÖ Dock optimizado y aplicaciones configuradas"
    
    # === VENTANAS Y SISTEMA ===
    echo "üîß Configurando ventanas y sistema..."
    
    # Desactivar animaciones de ventanas
    defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
    defaults write NSGlobalDomain NSWindowResizeTime -float 0.001
    defaults write NSGlobalDomain NSDocumentRevisionsWindowTransformAnimation -bool false
    defaults write NSGlobalDomain NSBrowserColumnAnimationSpeedMultiplier -float 0.0
    
    # Desactivar animaciones de di√°logos
    defaults write NSGlobalDomain NSUseAnimatedFocusRing -bool false
    defaults write NSGlobalDomain NSScrollAnimationEnabled -bool false
    defaults write NSGlobalDomain NSScrollViewRubberbanding -bool false
    
    # Desactivar efectos de transparencia
    defaults write NSGlobalDomain AppleEnableMenuBarTransparency -bool false
    
    # Desactivar animaciones de sheets
    defaults write NSGlobalDomain NSWindowCollectionBehavior -int 2
    
    echo "‚úÖ Ventanas optimizadas"
    
    # === FINDER ===
    echo "üîß Configurando Finder..."
    
    # Desactivar todas las animaciones del Finder
    defaults write com.apple.finder DisableAllAnimations -bool true
    defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
    
    # Desactivar animaciones de zoom de iconos
    defaults write com.apple.finder FK_AppCentricShowSidebar -bool false
    defaults write com.apple.finder FXEnableRemoveFromDockWarning -bool false
    
    # Optimizar vista de archivos
    defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
    defaults write com.apple.finder NewWindowTarget -string "PfHm"
    
    echo "‚úÖ Finder optimizado"
    
    # === MISSION CONTROL Y SPACES ===
    echo "üîß Configurando Mission Control..."
    
    # Desactivar animaciones de Mission Control
    defaults write com.apple.dock expose-animation-duration -float 0.0
    defaults write com.apple.dock expose-group-apps -bool false
    
    # Desactivar animaciones de Spaces
    defaults write com.apple.dock workspaces-auto-swoosh -bool false
    defaults write com.apple.dock workspaces-edge-delay -float 0.0
    
    # Desactivar reagrupaci√≥n autom√°tica de Spaces
    defaults write com.apple.dock mru-spaces -bool false
    
    echo "‚úÖ Mission Control optimizado"
    
    # === LAUNCHPAD ===
    echo "üîß Configurando Launchpad..."
    
    # Desactivar completamente animaciones de Launchpad
    defaults write com.apple.dock springboard-show-duration -float 0.0
    defaults write com.apple.dock springboard-hide-duration -float 0.0
    defaults write com.apple.dock springboard-page-duration -float 0.0
    
    echo "‚úÖ Launchpad optimizado"
    
    # === MAIL ===
    echo "üîß Configurando Mail..."
    
    # Desactivar animaciones de Mail
    defaults write com.apple.mail DisableReplyAnimations -bool true
    defaults write com.apple.mail DisableSendAnimations -bool true
    defaults write com.apple.mail DisableInlineAttachmentViewing -bool true
    
    echo "‚úÖ Mail optimizado"
    
    # === SAFARI ===
    echo "üîß Configurando Safari..."
    
    # Desactivar animaciones de Safari
    defaults write com.apple.Safari WebKitInitialTimedLayoutDelay -float 0.0
    defaults write com.apple.Safari WebKitResourceTimedLayoutDelay -float 0.0
    
    echo "‚úÖ Safari optimizado"
    
    # === ACCESIBILIDAD ===
    echo "üîß Configurando accesibilidad..."
    
    # Reducir movimiento (esto desactiva muchas animaciones del sistema)
    defaults write com.apple.universalaccess reduceMotion -bool true
    defaults write com.apple.universalaccess reduceTransparency -bool true
    
    # Desactivar efectos de zoom
    defaults write com.apple.universalaccess closeViewScrollWheelToggle -bool false
    defaults write com.apple.universalaccess HIDScrollZoomModifierMask -int 0
    
    echo "‚úÖ Accesibilidad optimizada"
    
    # === EFECTOS DE SONIDO ===
    echo "üîß Configurando efectos de sonido..."
    
    # Desactivar efectos de sonido de interfaz
    defaults write com.apple.systemsound com.apple.sound.beep.volume -float 0.0
    defaults write com.apple.systemsound com.apple.sound.uiaudio.enabled -bool false
    
    echo "‚úÖ Efectos de sonido optimizados"
    
    # === ENERGY SAVER ===
    echo "üîß Configurando ahorro de energ√≠a..."
    
    # Optimizar configuraciones de energ√≠a para rendimiento
    sudo pmset -a displaysleep 15
    sudo pmset -a disksleep 30
    sudo pmset -a sleep 60
    sudo pmset -a womp 0
    
    echo "‚úÖ Ahorro de energ√≠a optimizado"
    
    # === REINICIAR SERVICIOS ===
    echo "üîÑ Reiniciando servicios del sistema..."
    
    # Reiniciar servicios principales
    killall Dock 2>/dev/null || true
    killall Finder 2>/dev/null || true
    killall SystemUIServer 2>/dev/null || true
    killall NotificationCenter 2>/dev/null || true
    
    # Limpiar cache de Launch Services
    /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -kill -r -domain local -domain system -domain user
    
    echo "=================================================="
    echo "üéâ OPTIMIZACI√ìN EXTREMA COMPLETADA!"
    echo "‚ö° Tu Mac ahora est√° optimizado para m√°ximo rendimiento"
    echo "üí° Todas las animaciones innecesarias han sido desactivadas"
    echo "üìä Reinicia tu Mac para aplicar todos los cambios"
}

# Funci√≥n para activar animaciones (restaurar)
activar_animaciones() {
    echo "üîÑ Restaurando animaciones por defecto..."
    echo "=========================================="
    
    # Restaurar Dock
    defaults delete com.apple.dock mineffect 2>/dev/null || true
    defaults delete com.apple.dock minimize-to-application 2>/dev/null || true
    defaults delete com.apple.dock minimize-duration 2>/dev/null || true
    defaults delete com.apple.dock springboard-minimize-duration 2>/dev/null || true
    defaults delete com.apple.dock launchanim 2>/dev/null || true
    defaults delete com.apple.dock expose-animation-duration 2>/dev/null || true
    defaults delete com.apple.dock springboard-show-duration 2>/dev/null || true
    defaults delete com.apple.dock springboard-hide-duration 2>/dev/null || true
    defaults delete com.apple.dock springboard-page-duration 2>/dev/null || true
    defaults delete com.apple.dock magnification 2>/dev/null || true
    defaults delete com.apple.dock no-bouncing 2>/dev/null || true
    defaults delete com.apple.dock autohide-delay 2>/dev/null || true
    defaults delete com.apple.dock autohide-time-modifier 2>/dev/null || true
    
    # Restaurar ventanas
    defaults delete NSGlobalDomain NSAutomaticWindowAnimationsEnabled 2>/dev/null || true
    defaults delete NSGlobalDomain NSWindowResizeTime 2>/dev/null || true
    defaults delete NSGlobalDomain NSDocumentRevisionsWindowTransformAnimation 2>/dev/null || true
    defaults delete NSGlobalDomain NSBrowserColumnAnimationSpeedMultiplier 2>/dev/null || true
    defaults delete NSGlobalDomain NSUseAnimatedFocusRing 2>/dev/null || true
    defaults delete NSGlobalDomain NSScrollAnimationEnabled 2>/dev/null || true
    defaults delete NSGlobalDomain NSScrollViewRubberbanding 2>/dev/null || true
    defaults delete NSGlobalDomain AppleEnableMenuBarTransparency 2>/dev/null || true
    
    # Restaurar Finder
    defaults delete com.apple.finder DisableAllAnimations 2>/dev/null || true
    
    # Restaurar Mission Control
    defaults delete com.apple.dock expose-group-apps 2>/dev/null || true
    defaults delete com.apple.dock workspaces-auto-swoosh 2>/dev/null || true
    defaults delete com.apple.dock workspaces-edge-delay 2>/dev/null || true
    defaults delete com.apple.dock mru-spaces 2>/dev/null || true
    
    # Restaurar Mail
    defaults delete com.apple.mail DisableReplyAnimations 2>/dev/null || true
    defaults delete com.apple.mail DisableSendAnimations 2>/dev/null || true
    defaults delete com.apple.mail DisableInlineAttachmentViewing 2>/dev/null || true
    
    # Restaurar Safari
    defaults delete com.apple.Safari WebKitInitialTimedLayoutDelay 2>/dev/null || true
    defaults delete com.apple.Safari WebKitResourceTimedLayoutDelay 2>/dev/null || true
    
    # Restaurar accesibilidad
    defaults delete com.apple.universalaccess reduceMotion 2>/dev/null || true
    defaults delete com.apple.universalaccess reduceTransparency 2>/dev/null || true
    
    # Restaurar efectos de sonido
    defaults delete com.apple.systemsound com.apple.sound.beep.volume 2>/dev/null || true
    defaults delete com.apple.systemsound com.apple.sound.uiaudio.enabled 2>/dev/null || true
    
    # Reiniciar servicios
    killall Dock 2>/dev/null || true
    killall Finder 2>/dev/null || true
    killall SystemUIServer 2>/dev/null || true
    
    echo "=========================================="
    echo "üéâ Animaciones restauradas exitosamente!"
    echo "üí° Tu sistema ahora tiene todas las animaciones por defecto"
}

# Funci√≥n para mostrar estado detallado
mostrar_estado_detallado() {
    echo "üìä ESTADO DETALLADO DEL SISTEMA"
    echo "=================================="
    
    echo "üîπ DOCK:"
    echo "   Efecto minimizar: $(defaults read com.apple.dock mineffect 2>/dev/null || echo 'sin efecto/por defecto')"
    echo "   Animaciones launch: $(defaults read com.apple.dock launchanim 2>/dev/null || echo 'activadas')"
    echo "   Auto-hide delay: $(defaults read com.apple.dock autohide-delay 2>/dev/null || echo 'por defecto')"
    echo "   Magnificaci√≥n: $(defaults read com.apple.dock magnification 2>/dev/null || echo 'por defecto')"
    
    echo ""
    echo "üîπ VENTANAS:"
    echo "   Animaciones autom√°ticas: $(defaults read NSGlobalDomain NSAutomaticWindowAnimationsEnabled 2>/dev/null || echo 'activadas')"
    echo "   Tiempo de resize: $(defaults read NSGlobalDomain NSWindowResizeTime 2>/dev/null || echo 'por defecto')"
    echo "   Scroll con animaci√≥n: $(defaults read NSGlobalDomain NSScrollAnimationEnabled 2>/dev/null || echo 'activado')"
    
    echo ""
    echo "üîπ FINDER:"
    echo "   Animaciones: $(if [ "$(defaults read com.apple.finder DisableAllAnimations 2>/dev/null)" = "1" ]; then echo 'desactivadas'; else echo 'activadas'; fi)"
    
    echo ""
    echo "üîπ ACCESIBILIDAD:"
    echo "   Reducir movimiento: $(defaults read com.apple.universalaccess reduceMotion 2>/dev/null || echo 'desactivado')"
    echo "   Reducir transparencia: $(defaults read com.apple.universalaccess reduceTransparency 2>/dev/null || echo 'desactivado')"
    
    echo ""
    echo "üîπ MISSION CONTROL:"
    echo "   Duraci√≥n animaci√≥n: $(defaults read com.apple.dock expose-animation-duration 2>/dev/null || echo 'por defecto')"
    echo "   Reagrupar Spaces: $(defaults read com.apple.dock mru-spaces 2>/dev/null || echo 'activado')"
    
    echo "=================================="
}

# Funci√≥n para configurar aplicaciones del Dock
configurar_dock_apps() {
    echo "üöÄ CONFIGURANDO APLICACIONES DEL DOCK"
    echo "===================================="
    
    # Funci√≥n auxiliar para agregar aplicaci√≥n al Dock
    agregar_app_al_dock() {
        local app_path="$1"
        if [ -e "$app_path" ]; then
            defaults write com.apple.dock persistent-apps -array-add "<dict><key>tile-data</key><dict><key>file-data</key><dict><key>_CFURLString</key><string>$app_path</string><key>_CFURLStringType</key><integer>0</integer></dict></dict></dict>"
            echo "   ‚úì Agregada: $(basename "$app_path")"
        else
            echo "   ‚úó No encontrada: $(basename "$app_path")"
        fi
    }
    
    echo "üóëÔ∏è  Limpiando Dock actual..."
    defaults write com.apple.dock persistent-apps -array
    
    echo ""
    echo "‚ûï Agregando aplicaciones en orden:"
    agregar_app_al_dock "/Applications/Google Chrome.app"
    agregar_app_al_dock "/Applications/Firefox.app"
    agregar_app_al_dock "/Applications/Slack.app"
    agregar_app_al_dock "/System/Applications/Utilities/Terminal.app"
    agregar_app_al_dock "/Applications/ChatGPT.app"
    agregar_app_al_dock "/Applications/Cursor.app"
    
    echo ""
    echo "üîÑ Reiniciando Dock..."
    killall Dock
    
    echo ""
    echo "===================================="
    echo "‚úÖ Dock configurado exitosamente!"
    echo "üéØ Las aplicaciones aparecer√°n en el orden solicitado"
}

# Funci√≥n para limpiar sistema
limpiar_sistema() {
    echo "üßπ LIMPIANDO SISTEMA..."
    echo "======================="
    
    # Limpiar caches
    echo "üîÑ Limpiando caches..."
    sudo rm -rf /System/Library/Caches/* 2>/dev/null || true
    rm -rf ~/Library/Caches/* 2>/dev/null || true
    
    # Limpiar logs
    echo "üîÑ Limpiando logs..."
    sudo rm -rf /private/var/log/* 2>/dev/null || true
    rm -rf ~/Library/Logs/* 2>/dev/null || true
    
    # Reconstruir Launch Services
    echo "üîÑ Reconstruyendo Launch Services..."
    /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -kill -r -domain local -domain system -domain user
    
    # Limpiar DNS cache
    echo "üîÑ Limpiando DNS cache..."
    sudo dscacheutil -flushcache
    
    echo "======================="
    echo "‚úÖ Sistema limpiado exitosamente!"
}

# Validar entrada
validar_entrada() {
    case "$1" in
        [1-8]) return 0 ;;
        *) return 1 ;;
    esac
}

# Men√∫ principal mejorado
while true; do
    clear
    echo "‚ö° GESTOR DE ANIMACIONES MACOS - VERSI√ìN OPTIMIZADA"
    echo "=================================================="
    echo "1. üöÄ Desactivar TODAS las animaciones (MODO EXTREMO)"
    echo "2. ‚úÖ Activar todas las animaciones (RESTAURAR)"
    echo "3. üìä Ver estado detallado del sistema"
    echo "4. üíæ Crear backup de configuraciones"
    echo "5. üßπ Limpiar sistema (caches, logs, etc.)"
    echo "6. üîÑ Reiniciar servicios del sistema"
    echo "7. üéØ Configurar aplicaciones del Dock"
    echo "8. üö™ Salir"
    echo "=================================================="
    echo -n "Selecciona una opci√≥n (1-8): "
    
    read opcion
    
    if ! validar_entrada "$opcion"; then
        echo "‚ùå Opci√≥n inv√°lida. Intenta de nuevo."
        sleep 2
        continue
    fi
    
    case $opcion in
        1)
            clear
            echo "‚ö†Ô∏è  ADVERTENCIA: Esto desactivar√° TODAS las animaciones del sistema"
            echo "¬øEst√°s seguro? Esto puede hacer que tu Mac se vea muy diferente."
            echo "¬øContinuar? (y/n): "
            read -r respuesta
            if [[ "$respuesta" =~ ^[Yy]$ ]]; then
                crear_backup
                desactivar_animaciones_extremo
            else
                echo "Operaci√≥n cancelada"
            fi
            echo ""
            echo "Presiona cualquier tecla para continuar..."
            read -n 1 -s
            ;;
        2)
            clear
            echo "üîÑ Esto restaurar√° todas las animaciones por defecto"
            echo "¬øContinuar? (y/n): "
            read -r respuesta
            if [[ "$respuesta" =~ ^[Yy]$ ]]; then
                activar_animaciones
            else
                echo "Operaci√≥n cancelada"
            fi
            echo ""
            echo "Presiona cualquier tecla para continuar..."
            read -n 1 -s
            ;;
        3)
            clear
            mostrar_estado_detallado
            echo ""
            echo "Presiona cualquier tecla para continuar..."
            read -n 1 -s
            ;;
        4)
            clear
            crear_backup
            ;;
        5)
            clear
            echo "‚ö†Ô∏è  Esto limpiar√° caches y logs del sistema"
            echo "¬øContinuar? (y/n): "
            read -r respuesta
            if [[ "$respuesta" =~ ^[Yy]$ ]]; then
                limpiar_sistema
            else
                echo "Operaci√≥n cancelada"
            fi
            echo ""
            echo "Presiona cualquier tecla para continuar..."
            read -n 1 -s
            ;;
        6)
            clear
            echo "üîÑ Reiniciando servicios del sistema..."
            killall Dock 2>/dev/null || true
            killall Finder 2>/dev/null || true
            killall SystemUIServer 2>/dev/null || true
            killall NotificationCenter 2>/dev/null || true
            echo "‚úÖ Servicios reiniciados"
            echo ""
            echo "Presiona cualquier tecla para continuar..."
            read -n 1 -s
            ;;
        7)
            clear
            configurar_dock_apps
            echo ""
            echo "Presiona cualquier tecla para continuar..."
            read -n 1 -s
            ;;
        8)
            echo "¬°Hasta luego! üëã"
            exit 0
            ;;
    esac
done
